(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();const L=8,y=10;var d=(g=>(g[g.EMPTY=0]="EMPTY",g[g.BLOCK=1]="BLOCK",g[g.TRIANGLE_TL=2]="TRIANGLE_TL",g[g.TRIANGLE_TR=3]="TRIANGLE_TR",g[g.TRIANGLE_BR=4]="TRIANGLE_BR",g[g.TRIANGLE_BL=5]="TRIANGLE_BL",g[g.ABSORB=6]="ABSORB",g))(d||{});const b={TRAINING:"Training",NORMAL:"Normal",MITTEL:"Mittel",SCHWER:"Schwer"},v={GELB:"#f1c40f",ROT:"#e74c3c",BLAU:"#3498db",WEISS:"#ecf0f1",TRANSPARENT:"#95a5a6",LILA:"#9b59b6",HIMMELBLAU:"#5dade2",GRUEN:"#2ecc71",PINK:"#ff8a80",ORANGE:"#e67e22",ZITRONE:"#ffff8d",HELLLILA:"#ba68c8",SCHWARZ_GEM:"#1d1d1d",SCHWARZ_MIX:"#34495e",HELLGRUEN:"#81c784",HELLORANGE:"#ffb74d",GRAU:"#9e9e9e",ABSORBIERT:"#17202a",correct:"#4caf50",INVALID_GEM:"#e74c3c"},x={BLAU:v.BLAU,GELB:v.GELB,ROT:v.ROT,WEISS:v.WEISS,"BLAU,ROT":v.LILA,"BLAU,WEISS":v.HIMMELBLAU,"BLAU,GELB":v.GRUEN,"ROT,WEISS":v.PINK,"GELB,ROT":v.ORANGE,"GELB,WEISS":v.ZITRONE,"BLAU,ROT,WEISS":v.HELLLILA,"BLAU,GELB,ROT":v.SCHWARZ_MIX,"BLAU,GELB,WEISS":v.HELLGRUEN,"GELB,ROT,WEISS":v.HELLORANGE,"BLAU,GELB,ROT,WEISS":v.GRAU},N={BLAU:"Blau",GELB:"Gelb",ROT:"Rot",WEISS:"Weiss","BLAU,ROT":"Lila","BLAU,WEISS":"Himmelblau","BLAU,GELB":"Grün","ROT,WEISS":"Hellrot","GELB,ROT":"Orange","GELB,WEISS":"Hellgelb","BLAU,ROT,WEISS":"Hell-Lila","BLAU,GELB,ROT":"Dunkelgrau","BLAU,GELB,WEISS":"Hellgrün","GELB,ROT,WEISS":"Hell-Orange","BLAU,GELB,ROT,WEISS":"Grau"},B={GELB:{name:"GELB",color:v.GELB,baseGems:["GELB"],gridPattern:[[d.TRIANGLE_BL,d.EMPTY],[d.BLOCK,d.TRIANGLE_BL]]},ROT:{name:"ROT",color:v.ROT,baseGems:["ROT"],gridPattern:[[d.TRIANGLE_BR,d.BLOCK,d.TRIANGLE_TL]]},BLAU:{name:"BLAU",color:v.BLAU,baseGems:["BLAU"],gridPattern:[[d.EMPTY,d.TRIANGLE_BR,d.TRIANGLE_BL,d.EMPTY],[d.TRIANGLE_BR,d.BLOCK,d.BLOCK,d.TRIANGLE_BL]]},WEISS_RAUTE:{name:"WEISS_RAUTE",color:v.WEISS,baseGems:["WEISS"],gridPattern:[[d.TRIANGLE_BR,d.TRIANGLE_BL],[d.TRIANGLE_TR,d.TRIANGLE_TL]]},WEISS_DREIECK:{name:"WEISS_DREIECK",color:v.WEISS,baseGems:["WEISS"],gridPattern:[[d.EMPTY,d.TRIANGLE_BR,d.TRIANGLE_BL,d.EMPTY],[d.TRIANGLE_BR,d.BLOCK,d.BLOCK,d.TRIANGLE_BL]]},TRANSPARENT:{name:"TRANSPARENT",color:v.TRANSPARENT,baseGems:[],gridPattern:[[d.TRIANGLE_BR,d.TRIANGLE_BL]]},SCHWARZ:{name:"SCHWARZ",color:v.SCHWARZ_GEM,baseGems:[],special:"absorbs",gridPattern:[[d.ABSORB,d.ABSORB]]}},O={[b.TRAINING]:["GELB","ROT","BLAU","WEISS_RAUTE","WEISS_DREIECK"],[b.NORMAL]:["GELB","ROT","BLAU","WEISS_RAUTE","WEISS_DREIECK"],[b.MITTEL]:["GELB","ROT","BLAU","WEISS_RAUTE","WEISS_DREIECK","TRANSPARENT"],[b.SCHWER]:["GELB","ROT","BLAU","WEISS_RAUTE","WEISS_DREIECK","TRANSPARENT","SCHWARZ"]},H={[b.TRAINING]:[{limit:8,text:"Sehr gut"},{limit:10,text:"Gut"},{limit:20,text:"Normal"},{limit:1/0,text:"Verbesserungsfähig"}],[b.NORMAL]:[{limit:10,text:"Ein wahrer Experte bei der Edelsteinsuche"},{limit:13,text:"Ein Profi, dem kaum einer was vormacht"},{limit:18,text:"Guter Edelsteinsucher"},{limit:23,text:"Juhu, alle Edelsteine gefunden!"},{limit:1/0,text:"Immerhin alle Edelsteine gefunden."}],[b.MITTEL]:[{limit:12,text:"Meisterlich! Kaum eine Abfrage zu viel."},{limit:15,text:"Sehr beeindruckend! Du kennst dich aus."},{limit:20,text:"Starke Leistung! Du hast den Dreh raus."},{limit:25,text:"Gut gemacht! Alle Schätze geborgen."},{limit:1/0,text:"Geduld und Spucke führen zum Ziel!"}],[b.SCHWER]:[{limit:15,text:"Legendär! Eine Leistung für die Geschichtsbücher."},{limit:18,text:"Herausragend! Selbst Experten staunen."},{limit:21,text:"Experten-Niveau! Du hast es wirklich drauf."},{limit:25,text:"Ein hartes Stück Arbeit, aber erfolgreich!"},{limit:1/0,text:"Puh, das war knapp, aber gewonnen!"}]};var A=(g=>(g[g.MAIN_MENU=0]="MAIN_MENU",g[g.DIFFICULTY_SELECT=1]="DIFFICULTY_SELECT",g[g.PLAYING=2]="PLAYING",g[g.GAME_OVER=3]="GAME_OVER",g))(A||{});const l={status:0,difficulty:null,secretGems:[],playerGems:[],log:[],waveCount:0,debugMode:!1,showPlayerPathPreview:!1,selectedLogEntryWaveId:null,previewSourceEmitterId:null,activePlayerPath:null,activePlayerResult:null};var P=(g=>(g[g.UP=0]="UP",g[g.RIGHT=1]="RIGHT",g[g.DOWN=2]="DOWN",g[g.LEFT=3]="LEFT",g))(P||{});const V={[d.BLOCK]:{0:2,1:3,2:0,3:1},[d.TRIANGLE_TR]:{0:3,1:2,2:0,3:1},[d.TRIANGLE_BL]:{0:2,1:3,2:1,3:0},[d.TRIANGLE_TL]:{0:1,1:3,2:0,3:2},[d.TRIANGLE_BR]:{0:2,1:0,2:3,3:1}},X={[d.EMPTY]:d.EMPTY,[d.BLOCK]:d.BLOCK,[d.ABSORB]:d.ABSORB,[d.TRIANGLE_TL]:d.TRIANGLE_TR,[d.TRIANGLE_TR]:d.TRIANGLE_BR,[d.TRIANGLE_BR]:d.TRIANGLE_BL,[d.TRIANGLE_BL]:d.TRIANGLE_TL};function z(g,e){var t;return g===d.EMPTY?null:((t=V[g])==null?void 0:t[e])??null}function D(g){const e=g.length,t=g[0].length,n=Array.from({length:t},()=>Array(e).fill(d.EMPTY));for(let i=0;i<e;i++)for(let s=0;s<t;s++)n[s][e-1-i]=X[g[i][s]];return n}const Z=100;function q(g){const e=parseInt(g.substring(1))-1;switch(g[0]){case"T":return{pos:{x:e,y:-1},dir:P.DOWN};case"B":return{pos:{x:e,y},dir:P.UP};case"L":return{pos:{x:-1,y:e},dir:P.RIGHT};case"R":return{pos:{x:L,y:e},dir:P.LEFT};default:return null}}function j(g){return g.y<0?`T${g.x+1}`:g.y>=y?`B${g.x+1}`:g.x<0?`L${g.y+1}`:g.x>=L?`R${g.y+1}`:"Error"}function J(g,e){switch(e){case P.UP:g.y--;break;case P.DOWN:g.y++;break;case P.LEFT:g.x--;break;case P.RIGHT:g.x++;break}}function W(g,e,t){const n=q(t);if(!n)return{exitId:"Error",colors:[],path:[],absorbed:!1};const i={...n.pos};let s=n.dir;const r=[],o=new Set,a=new Set;for(let h=0;h<Z;h++){if(J(i,s),r.length===0&&r.push({x:n.pos.x+(n.dir===P.RIGHT?1:n.dir===P.LEFT?0:.5),y:n.pos.y+(n.dir===P.DOWN?1:n.dir===P.UP?0:.5)}),i.x<0||i.x>=L||i.y<0||i.y>=y)return r.push({x:i.x+(s===P.LEFT?1:s===P.RIGHT?0:.5),y:i.y+(s===P.UP?1:s===P.DOWN?0:.5)}),{exitId:j(i),colors:[...o],path:r,absorbed:!1};const c=g[i.y][i.x];if(c===d.EMPTY)continue;r.push({x:i.x+.5,y:i.y+.5});const u=`${i.y},${i.x}`,f=e.get(u);if(f&&!a.has(f.id)){a.add(f.id);const E=B[f.name];E.baseGems&&E.baseGems.forEach(p=>o.add(p))}if(c===d.ABSORB)return{exitId:"Absorbed",colors:[],path:r,absorbed:!0};const m=z(c,s);m!==null&&(s=m)}return{exitId:"Loop?",colors:[...o],path:r,absorbed:!1}}const U={[d.EMPTY]:[!1,!1,!1,!1],[d.BLOCK]:[!0,!0,!0,!0],[d.ABSORB]:[!0,!0,!0,!0],[d.TRIANGLE_TL]:[!0,!1,!1,!0],[d.TRIANGLE_TR]:[!0,!0,!1,!1],[d.TRIANGLE_BR]:[!1,!0,!0,!1],[d.TRIANGLE_BL]:[!1,!1,!0,!0]};class Q{constructor(e){this.secretGrid=[],this.secretGemMap=new Map,this.ui=e,this.ui.bindGame(this),this.showMainMenu()}_initSecretGrid(){this.secretGrid=Array.from({length:y},()=>Array(L).fill(d.EMPTY)),this.secretGemMap.clear()}showMainMenu(){l.status=A.MAIN_MENU,this.ui.showScreen("main")}showDifficultySelect(){l.status=A.DIFFICULTY_SELECT,this.ui.showScreen("difficulty")}showEndScreen(e){l.status=A.GAME_OVER,this.ui.showEndScreen(e,l.waveCount,l.secretGems,l.playerGems)}start(e){if(l.difficulty=e,l.status=A.PLAYING,this._initSecretGrid(),l.secretGems=this._placeSecretGems(),l.secretGems.length===0){this.showDifficultySelect();return}l.playerGems=[],l.log=[],l.waveCount=0,l.debugMode=!1,l.showPlayerPathPreview=!1,l.selectedLogEntryWaveId=null,l.previewSourceEmitterId=null,l.activePlayerPath=null,l.activePlayerResult=null,this.ui.setupGameUI(),this.ui.showScreen("game"),this.ui.redrawAll()}giveUp(){this.showEndScreen(!1)}toggleDebugMode(){l.debugMode=!l.debugMode,this.ui.redrawAll()}togglePlayerPathPreview(){l.showPlayerPathPreview=!l.showPlayerPathPreview,this.ui.updatePreviewToggleState(l.showPlayerPathPreview),this.ui.redrawAll()}sendWave(e){if(l.status!==A.PLAYING)return;l.waveCount++;const t=W(this.secretGrid,this.secretGemMap,e),n=Array.from({length:y},()=>Array(L).fill(d.EMPTY)),i=new Map;l.playerGems.forEach(o=>this._paintGemOnGrid(o,n,i));const s=W(n,i,e),r={waveId:e,result:t,path:t.path,playerPath:s.path,playerResult:s};l.log.push(r),this.ui.addLogEntry(r,e),this.setSelectedWave(e,e)}checkSolution(){const e=Array.from({length:y},()=>Array(L).fill(d.EMPTY)),t=new Map;l.playerGems.forEach(s=>this._paintGemOnGrid(s,e,t));const n=[];for(let s=1;s<=L;s++)n.push(`T${s}`,`B${s}`);for(let s=1;s<=y;s++)n.push(`L${s}`,`R${s}`);let i=!0;for(const s of n){const r=W(this.secretGrid,this.secretGemMap,s),o=W(e,t,s),a=[...r.colors].sort().join(","),h=[...o.colors].sort().join(",");if(r.exitId!==o.exitId||a!==h){i=!1;break}}this.showEndScreen(i)}addPlayerGem(e,t,n){if(l.playerGems.some(h=>h.name===e))return;const s=B[e];if(!s)return;const r={id:`player_${Date.now()}`,name:e,x:t,y:n,rotation:0,gridPattern:s.gridPattern,isValid:!1},o=r.gridPattern.length,a=r.gridPattern[0].length;r.x=Math.max(0,Math.min(t,L-a)),r.y=Math.max(0,Math.min(n,y-o)),l.playerGems.push(r),this._revalidateAllPlayerGems(),this._updateActivePlayerPathPreview(),this.updateSolutionButtonState(),this.ui.updateToolbar(),this.ui.redrawAll()}movePlayerGem(e,t,n){const i=l.playerGems.find(s=>s.id===e);if(i){const s=i.gridPattern.length,r=i.gridPattern[0].length;i.x=Math.max(0,Math.min(t,L-r)),i.y=Math.max(0,Math.min(n,y-s)),this._revalidateAllPlayerGems(),this._updateActivePlayerPathPreview(),this.updateSolutionButtonState(),this.ui.redrawAll()}}removePlayerGem(e){const t=l.playerGems.findIndex(n=>n.id===e);t>-1&&(l.playerGems.splice(t,1),this._revalidateAllPlayerGems(),this._updateActivePlayerPathPreview(),this.updateSolutionButtonState(),this.ui.updateToolbar(),this.ui.redrawAll())}rotatePlayerGem(e){const t=l.playerGems.find(n=>n.id===e);if(t){const n=t.gridPattern[0].length,i=t.gridPattern.length,s=t.x+n/2,r=t.y+i/2;t.rotation=(t.rotation+90)%360,t.gridPattern=D(t.gridPattern);const o=t.gridPattern[0].length,a=t.gridPattern.length;t.x=Math.round(s-o/2),t.y=Math.round(r-a/2),t.x=Math.max(0,Math.min(t.x,L-o)),t.y=Math.max(0,Math.min(t.y,y-a)),this._revalidateAllPlayerGems(),this._updateActivePlayerPathPreview(),this.updateSolutionButtonState(),this.ui.redrawAll()}}canPlaceGem(e){return this._isPlacementValid(e,l.playerGems)}setSelectedWave(e,t){l.selectedLogEntryWaveId=e,l.previewSourceEmitterId=t,this._updateActivePlayerPathPreview(),this.ui.handleSelectionChange()}_updateActivePlayerPathPreview(){if(!l.previewSourceEmitterId){l.activePlayerPath=null,l.activePlayerResult=null;return}const e=Array.from({length:y},()=>Array(L).fill(d.EMPTY)),t=new Map;l.playerGems.forEach(i=>this._paintGemOnGrid(i,e,t));const n=W(e,t,l.previewSourceEmitterId);l.activePlayerPath=n.path,l.activePlayerResult=n}_revalidateAllPlayerGems(){l.playerGems.forEach(e=>{e.isValid=this._isPlacementValid(e,l.playerGems)})}_doGemsCollide(e,t){const n=e.gridPattern.length,i=e.gridPattern[0].length,s=t.gridPattern.length,r=t.gridPattern[0].length,o=e.name==="SCHWARZ"||t.name==="SCHWARZ";for(let a=0;a<n;a++)for(let h=0;h<i;h++){const c=e.gridPattern[a][h];if(c===d.EMPTY)continue;const u=e.x+h,f=e.y+a;for(let m=0;m<s;m++)for(let E=0;E<r;E++){const p=t.gridPattern[m][E];if(p===d.EMPTY)continue;const T=t.x+E,R=t.y+m,w=Math.abs(u-T),I=Math.abs(f-R);if(o){if(w<=1&&I<=1)return!0}else{if(w===0&&I===0)return!0;if(w+I===1){const S=U[c],G=U[p];if(u<T){if(S[1]&&G[3])return!0}else if(u>T){if(S[3]&&G[1])return!0}else if(f<R){if(S[2]&&G[0])return!0}else if(S[0]&&G[2])return!0}}}}return!1}_isPlacementValid(e,t){const{gridPattern:n,x:i,y:s,id:r}=e,o=n.length,a=n[0].length;if(i<0||s<0||i+a>L||s+o>y)return!1;for(const h of t)if(!(r&&h.id===r)&&this._doGemsCollide(e,h))return!1;return!0}_paintGemOnGrid(e,t,n){const{gridPattern:i,x:s,y:r}=e;for(let o=0;o<i.length;o++)for(let a=0;a<i[o].length;a++){const h=i[o][a];h!==d.EMPTY&&t[r+o]&&t[r+o][s+a]!==void 0&&(t[r+o][s+a]=h,n==null||n.set(`${r+o},${s+a}`,e))}}updateSolutionButtonState(){var i;const e=((i=O[l.difficulty])==null?void 0:i.length)??0,t=l.playerGems.every(s=>s.isValid),n=l.playerGems.length===e;this.ui.checkSolutionBtn.disabled=!(t&&n)}_placeSecretGems(){const e=[],t=O[l.difficulty];let n=0;for(;e.length<t.length&&n<500;){n++,e.length=0;for(const i of t){const s=B[i];let r=!1,o=0;for(;!r&&o<200;){o++;let a=s.gridPattern;const h=Math.floor(Math.random()*4);for(let p=0;p<h;p++)a=D(a);const c=a.length,u=a[0].length;if(L<u||y<c)continue;const f=Math.floor(Math.random()*(L-u+1)),m=Math.floor(Math.random()*(y-c+1)),E={id:`secret_${i}_${e.length}`,name:i,x:f,y:m,rotation:h*90,gridPattern:a};this._isPlacementValid(E,e)&&(e.push(E),r=!0)}if(!r)break}}return e.length!==t.length?(console.error("Failed to place all secret gems!"),alert("Fehler bei der Level-Erstellung. Bitte versuchen Sie es erneut."),[]):(e.forEach(i=>this._paintGemOnGrid(i,this.secretGrid,this.secretGemMap)),console.log("Secret gems placed:",e),e)}}class _{constructor(e,t){this.state="normal",this.isUsed=!1,this.usedColor=null,this.cornerRadius=4,this.id=e,this.label=t,this.rect={x:0,y:0,width:0,height:0}}isInside(e,t){return e>=this.rect.x&&e<=this.rect.x+this.rect.width&&t>=this.rect.y&&t<=this.rect.y+this.rect.height}draw(e,t=!1){e.save();const n=this.isUsed&&this.usedColor?this.usedColor:"#4a627a";e.beginPath();const i=new Path2D;i.roundRect(this.rect.x,this.rect.y,this.rect.width,this.rect.height,this.cornerRadius),e.fillStyle=n,e.fill(i),t?(e.strokeStyle="#f1c40f",e.lineWidth=3,e.shadowColor="#f1c40f",e.shadowBlur=8,e.stroke(i),e.shadowColor="transparent",e.shadowBlur=0):this.state==="focused"&&(e.strokeStyle="#3498db",e.lineWidth=2,e.stroke(i));const r=(o=>{if(!o||o.length<7)return"#ecf0f1";try{const a=parseInt(o.slice(1,3),16),h=parseInt(o.slice(3,5),16),c=parseInt(o.slice(5,7),16);return a*.299+h*.587+c*.114>186?"#2c3e50":"#ecf0f1"}catch{return"#ecf0f1"}})(n);e.fillStyle=r,e.font=`bold ${this.rect.height*.45}px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(this.label,this.rect.x+this.rect.width/2,this.rect.y+this.rect.height/2),e.restore()}}class ee{constructor(){this.screens={},this.emitters=[],this.focusedEmitterId=null,this.dragStartInfo=null,this.isDragging=!1,this.draggedItemInfo=null,this.dragPos={x:0,y:0},this.lastValidDropTarget={x:-1,y:-1,isValid:!1},this.cellWidth=0,this.cellHeight=0,this.gap=1,this.cacheDOMElements(),this.bindGlobalEvents(),this._populateIntroRules()}bindGame(e){this.game=e}cacheDOMElements(){this.screens.main=document.getElementById("screen-main"),this.screens.difficulty=document.getElementById("screen-difficulty"),this.screens.game=document.getElementById("screen-game"),this.screens.end=document.getElementById("screen-end"),this.btnStartGame=document.getElementById("btn-start-game"),this.introRulesEl=document.getElementById("intro-rules"),this.difficultyOptions=document.getElementById("difficulty-options"),this.btnBackToMain1=document.getElementById("btn-back-to-main-1"),this.boardWrapper=document.getElementById("game-board-wrapper"),this.gemCanvas=document.getElementById("gem-canvas"),this.gemCtx=this.gemCanvas.getContext("2d"),this.pathOverlay=document.getElementById("path-overlay"),this.pathCtx=this.pathOverlay.getContext("2d"),this.gemToolbar=document.getElementById("gem-toolbar"),this.logList=document.getElementById("log-list"),this.actionsTabBtn=document.getElementById("actions-tab-btn"),this.logTabBtn=document.getElementById("log-tab-btn"),this.rulesTabBtn=document.getElementById("rules-tab-btn"),this.rulesPanel=document.getElementById("rules-panel"),this.checkSolutionBtn=document.getElementById("check-solution-btn"),this.giveUpBtn=document.getElementById("give-up-btn"),this.previewToggle=document.getElementById("preview-toggle"),this.endTitle=document.getElementById("end-title"),this.endRating=document.getElementById("end-rating"),this.endStats=document.getElementById("end-stats"),this.endRetryMessage=document.getElementById("end-retry-message"),this.endSolutionCanvas=document.getElementById("end-solution-canvas"),this.endSolutionCtx=this.endSolutionCanvas.getContext("2d"),this.endSolutionLabel=document.getElementById("end-solution-label"),this.endRatingLegend=document.getElementById("end-rating-legend"),this.btnNewLevel=document.getElementById("btn-new-level"),this.btnMenu=document.getElementById("btn-menu")}bindGlobalEvents(){this.btnStartGame.addEventListener("click",()=>this.game.showDifficultySelect()),this.btnNewLevel.addEventListener("click",()=>{l.difficulty&&this.game.start(l.difficulty)}),this.btnMenu.addEventListener("click",()=>this.game.showMainMenu()),this.btnBackToMain1.addEventListener("click",()=>this.game.showMainMenu()),this.actionsTabBtn.addEventListener("click",()=>this.switchTab("actions")),this.logTabBtn.addEventListener("click",()=>this.switchTab("log")),this.rulesTabBtn.addEventListener("click",()=>this.switchTab("rules")),this.checkSolutionBtn.addEventListener("click",()=>this.game.checkSolution()),this.giveUpBtn.addEventListener("click",()=>this.game.giveUp()),this.previewToggle.addEventListener("change",()=>this.game.togglePlayerPathPreview()),this.gemCanvas.addEventListener("keydown",e=>this.handleCanvasKeyDown(e)),document.addEventListener("keydown",e=>{if(e.key==="n"&&(l.status===A.PLAYING||l.status===A.GAME_OVER)){l.difficulty&&this.game.start(l.difficulty);return}if(e.key==="Escape"&&(l.status===A.PLAYING||l.status===A.GAME_OVER)){this.game.showMainMenu();return}l.status===A.PLAYING&&(e.key==="d"&&this.game.toggleDebugMode(),e.key==="f"&&this.game.togglePlayerPathPreview())}),document.addEventListener("click",e=>this.handleGlobalClick(e)),this.logList.addEventListener("click",e=>this.handleLogClick(e)),document.addEventListener("mousedown",e=>this.handlePointerDown(e)),document.addEventListener("touchstart",e=>this.handlePointerDown(e),{passive:!1}),document.addEventListener("mousemove",e=>this.handlePointerMove(e)),document.addEventListener("touchmove",e=>this.handlePointerMove(e),{passive:!1}),document.addEventListener("mouseup",e=>this.handlePointerUp(e)),document.addEventListener("touchend",e=>this.handlePointerUp(e)),this.logList.addEventListener("animationend",()=>{this.logList.classList.remove("flash")})}handleGlobalClick(e){if(!l.selectedLogEntryWaveId)return;const t=e.target;t.closest("#gem-canvas")||t.closest("#log-list li")||t.closest(".preview-toggle-wrapper")||this.game.setSelectedWave(null,null)}setupGameUI(){this._populateRulesPanel(),this.switchTab("actions"),this._createEmitterObjects(),this.updateToolbar(),this.logList.innerHTML="",this.updateLogTabCounter(),this.clearPath(),this.game.updateSolutionButtonState(),this.updatePreviewToggleState(l.showPlayerPathPreview),new ResizeObserver(()=>this.onBoardResize()).observe(this.boardWrapper),this.onBoardResize()}showScreen(e){e==="difficulty"&&this.populateDifficultyOptions(),Object.values(this.screens).forEach(t=>t.classList.add("hidden")),this.screens[e].classList.remove("hidden"),e==="game"&&this.gemCanvas.focus()}populateDifficultyOptions(){this.difficultyOptions.innerHTML="";const e={[b.TRAINING]:"Ideal zum Lernen des Spiels, mit dem Verlauf der Lichtstrahlen.",[b.NORMAL]:"Die Grundlagen. Lerne die farbigen und weissen Steine kennen.",[b.MITTEL]:"Eine neue Herausforderung. Ein transparenter Prisma-Stein lenkt das Licht ab, ohne es zu färben.",[b.SCHWER]:"Expertenmodus. Neben dem transparenten kommt ein schwarzer, Licht absorbierender Stein in Spiel."};Object.values(b).forEach(t=>{const n=document.createElement("button");n.innerHTML=`${t}<div class="difficulty-desc">${e[t]}</div>`,n.onclick=()=>this.game.start(t),this.difficultyOptions.appendChild(n)})}_createEmitterObjects(){this.emitters=[];for(let e=0;e<L;e++)this.emitters.push(new _(`T${e+1}`,`T${e+1}`));for(let e=0;e<L;e++)this.emitters.push(new _(`B${e+1}`,`B${e+1}`));for(let e=0;e<y;e++)this.emitters.push(new _(`L${e+1}`,`L${e+1}`));for(let e=0;e<y;e++)this.emitters.push(new _(`R${e+1}`,`R${e+1}`));this.emitters.length>0&&(this.focusedEmitterId=this.emitters[0].id)}onBoardResize(){const e=this.boardWrapper.getBoundingClientRect();if(e.width===0||e.height===0)return;const t=L+2,n=y+2;this.cellWidth=(e.width-(t-1)*this.gap)/t,this.cellHeight=(e.height-(n-1)*this.gap)/n;const i=window.devicePixelRatio||1;[this.pathOverlay,this.gemCanvas].forEach(s=>{s.width=e.width*i,s.height=e.height*i,s.style.width=`${e.width}px`,s.style.height=`${e.height}px`,s.getContext("2d").scale(i,i)}),this.emitters.forEach(s=>{const r=s.id,o=parseInt(r.substring(1))-1;let a=0,h=0;switch(r[0]){case"T":a=o+1,h=0;break;case"B":a=o+1,h=n-1;break;case"L":a=0,h=o+1;break;case"R":a=t-1,h=o+1;break}s.rect.x=a*(this.cellWidth+this.gap),s.rect.y=h*(this.cellHeight+this.gap),s.rect.width=this.cellWidth,s.rect.height=this.cellHeight}),this.redrawAll()}_getGemTooltip(e){var n;const t=B[e];if(!t)return"";switch(e){case"TRANSPARENT":return"Reflektiert nur, färbt nicht.";case"SCHWARZ":return"Absorbiert Licht.";default:if(t.baseGems&&t.baseGems.length>0){const i=t.baseGems[0];return`Fügt Farbe '${(n=N[i])==null?void 0:n.toLowerCase()}' hinzu.`}return`Edelstein ${e}`}}updateToolbar(){if(this.gemToolbar.innerHTML="",!l.difficulty)return;const e=new Set(l.playerGems.map(t=>t.name));O[l.difficulty].forEach(t=>{const n=B[t],i=document.createElement("div");i.className="toolbar-gem",e.has(t)&&i.classList.add("placed"),i.dataset.gemName=t,i.title=this._getGemTooltip(t);const s=document.createElement("canvas");s.className="toolbar-gem-canvas",i.appendChild(s),this.gemToolbar.appendChild(i),setTimeout(()=>this.drawToolbarGem(s,n),0)})}drawToolbarGem(e,t){const n=e.getContext("2d");if(!n)return;const i=window.devicePixelRatio||1,s=e.getBoundingClientRect();if(s.width===0||s.height===0)return;e.width=s.width*i,e.height=s.height*i,n.scale(i,i);const r=t.gridPattern,o=r.length,a=r[0].length,h=Math.max(a,o),c=s.width/h,u=s.height/h,f=(s.width-a*c)/2,m=(s.height-o*u)/2;for(let E=0;E<o;E++)for(let p=0;p<a;p++){const T=r[E][p];T!==d.EMPTY&&this.drawCellShape(n,p*c+f,E*u+m,c,u,T,t.color)}}handleSelectionChange(){this.redrawAll(),this.updateLogHighlight()}redrawAll(){if(this.gemCanvas.width===0)return;const e=this.gemCtx;e.clearRect(0,0,this.gemCanvas.width,this.gemCanvas.height),this._drawBoardBackgroundAndGrid(e);const t=l.selectedLogEntryWaveId?l.log.find(n=>n.waveId===l.selectedLogEntryWaveId):null;if(this.emitters.forEach(n=>{let i=!1;t&&(i=n.id===t.waveId||n.id===t.result.exitId),n.draw(e,i)}),this.clearPath(),t&&(l.difficulty===b.TRAINING||l.debugMode)&&t.path){const i=this.getPathColor(t.result);this.drawPath(t.path,i,!1)}if(l.showPlayerPathPreview&&l.activePlayerPath&&l.activePlayerResult){const n=this.getPathColor(l.activePlayerResult);this.drawPath(l.activePlayerPath,n,!0)}l.status===A.PLAYING&&(l.debugMode&&this.drawDebugSolution(e),this.drawPlayerGems(e),this._drawSelectedWaveTooltip(e),this.isDragging&&this.draggedItemInfo&&this.drawDragPreview(e))}drawDragPreview(e){if(!this.draggedItemInfo)return;const{gridPattern:t,name:n,id:i}=this.draggedItemInfo,s=B[n],r=t[0].length,o=t.length,a=this.dragPos.x/(this.cellWidth+this.gap)-1-r/2+.5,h=this.dragPos.y/(this.cellHeight+this.gap)-1-o/2+.5,c=Math.round(a),u=Math.round(h),f={id:i,name:n,x:c,y:u,gridPattern:t};this.lastValidDropTarget.isValid=this.game.canPlaceGem(f),this.lastValidDropTarget.x=c,this.lastValidDropTarget.y=u,e.save(),e.globalAlpha=.7;for(let m=0;m<o;m++)for(let E=0;E<r;E++)if(t[m][E]!==d.EMPTY){const p=this._gridToCanvasCoords(c+E,u+m);this.drawCellShape(e,p.x,p.y,this.cellWidth,this.cellHeight,t[m][E],s.color,!this.lastValidDropTarget.isValid)}e.restore()}drawPlayerGems(e){var t,n;for(const i of l.playerGems){if(this.isDragging&&((t=this.draggedItemInfo)==null?void 0:t.from)==="board"&&this.draggedItemInfo.id===i.id)continue;const{gridPattern:s,x:r,y:o,name:a}=i,h=B[a].color,c=!i.isValid;let u=!1;this.isDragging||(u=((n=this.getGemAtCanvasPos(this.dragPos.x,this.dragPos.y))==null?void 0:n.id)===i.id);for(let f=0;f<s.length;f++)for(let m=0;m<s[f].length;m++){const E=s[f][m];if(E!==d.EMPTY){const p=this._gridToCanvasCoords(r+m,o+f);this.drawCellShape(e,p.x,p.y,this.cellWidth,this.cellHeight,E,h,c,u)}}}}_drawBoardBackgroundAndGrid(e){e.save();const t=getComputedStyle(document.documentElement).getPropertyValue("--surface-color"),n=getComputedStyle(document.documentElement).getPropertyValue("--border-color");e.fillStyle=t,e.fillRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle=n,e.fillRect(this.cellWidth+this.gap/2,this.cellHeight+this.gap/2,L*this.cellWidth+(L+1)*this.gap,y*this.cellHeight+(y+1)*this.gap),e.fillStyle=t,e.fillRect(this.cellWidth+this.gap,this.cellHeight+this.gap,L*this.cellWidth+(L-1)*this.gap,y*this.cellHeight+(y-1)*this.gap),e.strokeStyle=n,e.lineWidth=this.gap,e.beginPath();for(let i=1;i<L;i++){const s=(i+1)*(this.cellWidth+this.gap)-this.gap/2;e.moveTo(s,this.cellHeight+this.gap),e.lineTo(s,(y+1)*(this.cellHeight+this.gap))}for(let i=1;i<y;i++){const s=(i+1)*(this.cellHeight+this.gap)-this.gap/2;e.moveTo(this.cellWidth+this.gap,s),e.lineTo((L+1)*(this.cellWidth+this.gap),s)}e.stroke(),e.restore()}drawDebugSolution(e){if(!(!this.game.secretGrid||l.secretGems.length===0)){e.save();for(const t of l.secretGems){const{gridPattern:n,x:i,y:s,name:r}=t,o=B[r].color;e.globalAlpha=.2;for(let a=0;a<n.length;a++)for(let h=0;h<n[a].length;h++){const c=n[a][h];if(c!==d.EMPTY){const u=this._gridToCanvasCoords(i+h,s+a);this.drawCellShape(e,u.x,u.y,this.cellWidth,this.cellHeight,c,o)}}}e.restore()}}drawCellShape(e,t,n,i,s,r,o,a=!1,h=!1){e.save(),o===v.TRANSPARENT?(e.fillStyle="rgba(164, 212, 228, 0.3)",e.strokeStyle="#a4d4e4",e.lineWidth=2):o===v.SCHWARZ_GEM?(e.fillStyle=o,e.strokeStyle="#555",e.lineWidth=1):(e.fillStyle=o,e.strokeStyle="rgba(0,0,0,0.4)",e.lineWidth=1),a&&(e.fillStyle="rgba(231, 76, 60, 0.5)",e.strokeStyle=v.INVALID_GEM,e.lineWidth=2),h&&!a&&(e.shadowColor="white",e.shadowBlur=10),e.beginPath();const c=new Path2D;switch(r){case d.BLOCK:case d.ABSORB:c.rect(t,n,i,s);break;case d.TRIANGLE_TL:c.moveTo(t,n),c.lineTo(t+i,n),c.lineTo(t,n+s),c.closePath();break;case d.TRIANGLE_TR:c.moveTo(t,n),c.lineTo(t+i,n),c.lineTo(t+i,n+s),c.closePath();break;case d.TRIANGLE_BR:c.moveTo(t+i,n),c.lineTo(t+i,n+s),c.lineTo(t,n+s),c.closePath();break;case d.TRIANGLE_BL:c.moveTo(t,n),c.lineTo(t,n+s),c.lineTo(t+i,n+s),c.closePath();break}e.fill(c),e.stroke(c),e.restore()}_gridToCanvasCoords(e,t){return{x:(e+1)*(this.cellWidth+this.gap),y:(t+1)*(this.cellHeight+this.gap)}}_canvasToGridCoords(e,t){return{x:Math.floor(e/(this.cellWidth+this.gap))-1,y:Math.floor(t/(this.cellHeight+this.gap))-1}}getPathColor(e){if(e.absorbed)return v.ABSORBIERT;if(e.colors.length===0)return"rgba(236, 240, 241, 0.7)";const t=[...e.colors].sort().join(",");return x[t]||"#ccc"}drawPath(e,t,n=!1){if(e.length<2)return;const i=this.pathCtx;i.save(),i.strokeStyle=t,i.lineWidth=3,i.lineCap="round",i.lineJoin="round",i.shadowColor="rgba(0,0,0,0.5)",i.shadowBlur=5,n&&(i.globalAlpha=.6,i.setLineDash([8,6])),i.beginPath();const s=this.cellWidth+this.gap,r=this.cellHeight+this.gap,o=this.cellWidth+this.gap,a=this.cellHeight+this.gap,h=u=>{const f=s+u.x*o,m=r+u.y*a;return{x:f,y:m}},c=h(e[0]);i.moveTo(c.x,c.y);for(let u=1;u<e.length;u++)i.lineTo(h(e[u]).x,h(e[u]).y);i.stroke(),i.restore()}clearPath(){this.pathCtx.clearRect(0,0,this.pathOverlay.width,this.pathOverlay.height)}switchTab(e){document.querySelectorAll(".tab-btn, .tab-panel").forEach(t=>t.classList.remove("active")),document.getElementById(`${e}-tab-btn`).classList.add("active"),document.getElementById(`${e}-panel`).classList.add("active")}addLogEntry(e,t){const n=document.createElement("li");n.dataset.waveId=t;const{result:i}=e,s=`${t} ➔ ${i.exitId}`,r=this.getPathColor(i),o=this._getPathColorName(i);n.innerHTML=`<span>${s}</span><div class="log-entry-result"><span class="log-color-name">${o}</span><div class="log-color-box" style="background-color: ${r};"></div></div>`,this.logList.prepend(n),this.updateLogTabCounter();const a=this.emitters.find(h=>h.id===t);if(a&&(a.isUsed=!0,a.usedColor=r),i.exitId&&i.exitId!=="Loop?"){const h=this.emitters.find(c=>c.id===i.exitId);h&&(h.isUsed=!0,h.usedColor=r)}}updateLogTabCounter(){const e=l.log.length;e>0?this.logTabBtn.textContent=`Logbuch (${e})`:this.logTabBtn.textContent="Logbuch"}_areGemSetsIdentical(e,t){if(e.length!==t.length)return!1;const n=r=>`${r.name},${r.x},${r.y},${JSON.stringify(r.gridPattern)}`,i=new Set(e.map(n)),s=new Set(t.map(n));if(i.size!==s.size)return!1;for(const r of i)if(!s.has(r))return!1;return!0}showEndScreen(e,t,n,i){this.endTitle.classList.remove("win","loss"),this.endRetryMessage.textContent="",this.endRating.textContent="",this.endRatingLegend.innerHTML="",this.endRating.style.display="none",this.endRatingLegend.style.display="none";let s=[];if(e){this.endTitle.textContent="Gewonnen!",this.endTitle.classList.add("win"),this.endStats.textContent=`Du hast die Mine in ${t} Abfragen gelöst.`,this._areGemSetsIdentical(n,i)?(this.endSolutionLabel.textContent="Korrekte Lösung:",s=[]):(this.endSolutionLabel.textContent="Alternative Lösung gefunden! Deine Lösung (transparent):",s=i);const o=l.difficulty;if(o&&H[o]){const a=H[o];let h="";for(const c of a)if(t<=c.limit){h=c.text;break}if(h){this.endRating.textContent=h,this.endRating.style.display="block",this.endRatingLegend.style.display="block";let c=`<h5>Bewertung für ${o}</h5><ul>`,u=0;a.forEach(f=>{const m=u===0?`bis ${f.limit} Abfragen`:f.limit===1/0?`mehr als ${u} Abfragen`:`${u+1} - ${f.limit} Abfragen`;c+=`<li><strong>${f.text}:</strong> ${m}</li>`,u=f.limit}),c+="</ul>",this.endRatingLegend.innerHTML=c}}}else this.endTitle.textContent="Verloren!",this.endTitle.classList.add("loss"),this.endStats.textContent=`Du hast ${t} Abfragen gebraucht.`,this.endRetryMessage.textContent="Bitte versuche es erneut.",this.endSolutionLabel.textContent="Deine Eingabe (über der korrekten Lösung):",s=i;this.showScreen("end"),requestAnimationFrame(()=>{this.drawEndScreenSolution(this.endSolutionCtx,n,s,this.emitters)})}drawEndScreenSolution(e,t,n,i){const s=e.canvas,r=window.devicePixelRatio||1,o=s.getBoundingClientRect();if(o.width===0||o.height===0)return;s.width=o.width*r,s.height=o.height*r,e.scale(r,r),e.clearRect(0,0,o.width,o.height);const a=1,h=L+2,c=y+2,u=(o.width-(h-1)*a)/h,f=(o.height-(c-1)*a)/c,m=(T,R,w)=>{e.save(),e.globalAlpha=R;for(const I of T){const S=B[I.name].color,G=w?!I.isValid:!1;for(let M=0;M<I.gridPattern.length;M++)for(let C=0;C<I.gridPattern[M].length;C++){const k=I.gridPattern[M][C];if(k!==d.EMPTY){const $=I.x+C,Y=I.y+M,K=($+1)*(u+a),F=(Y+1)*(f+a);this.drawCellShape(e,K,F,u,f,k,S,G)}}}e.restore()};e.save();const E=getComputedStyle(document.documentElement).getPropertyValue("--surface-color"),p=getComputedStyle(document.documentElement).getPropertyValue("--border-color");e.fillStyle=E,e.fillRect(0,0,o.width,o.height),e.fillStyle=p,e.fillRect(u+a/2,f+a/2,L*u+(L+1)*a,y*f+(y+1)*a),e.fillStyle=E,e.fillRect(u+a,f+a,L*(u+a)-a,y*(f+a)-a),e.strokeStyle=p,e.lineWidth=a,e.beginPath();for(let T=1;T<L;T++){const R=(T+1)*(u+a)-a/2;e.moveTo(R,f+a),e.lineTo(R,(y+1)*(f+a))}for(let T=1;T<y;T++){const R=(T+1)*(f+a)-a/2;e.moveTo(u+a,R),e.lineTo((L+1)*(u+a),R)}e.stroke(),e.restore(),i.forEach(T=>{const R=T.id,w=parseInt(R.substring(1))-1;let I=0,S=0;switch(R[0]){case"T":I=w+1,S=0;break;case"B":I=w+1,S=c-1;break;case"L":I=0,S=w+1;break;case"R":I=h-1,S=w+1;break}const G=Object.assign(new _(T.id,T.label),T);G.rect={x:I*(u+a),y:S*(f+a),width:u,height:f},G.state="normal",G.draw(e,!1)}),m(t,1,!1),n.length>0&&m(n,.55,!0)}handleLogClick(e){const t=e.target.closest("li");if(t&&t.dataset.waveId){const n=t.dataset.waveId;l.selectedLogEntryWaveId===n?this.game.setSelectedWave(null,null):this.game.setSelectedWave(n,n)}}handleCanvasHover(e,t){if(this.isDragging)return;const n=this.gemCanvas.getBoundingClientRect(),i=e-n.left,s=t-n.top;this.dragPos={x:i,y:s},this.redrawAll()}handleCanvasMouseLeave(){this.dragPos={x:-1,y:-1},this.redrawAll()}updatePreviewToggleState(e){this.previewToggle.checked=e}updateLogHighlight(){this.logList.querySelectorAll("li").forEach(e=>{const t=e;t.dataset.waveId===l.selectedLogEntryWaveId?(t.classList.add("selected"),t.scrollIntoView({behavior:"smooth",block:"nearest"})):t.classList.remove("selected")})}handleCanvasKeyDown(e){if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Enter"," "].includes(e.key))return;e.preventDefault();const t=this.emitters.find(s=>s.id===this.focusedEmitterId);if(t&&(t.state="normal"),e.key==="Enter"||e.key===" "){if(this.focusedEmitterId){const s=this.emitters.find(r=>r.id===this.focusedEmitterId);if(s&&!s.isUsed)this.game.sendWave(this.focusedEmitterId);else if(s!=null&&s.isUsed){const r=l.log.find(o=>o.waveId===s.id||o.result.exitId===s.id);r&&(l.selectedLogEntryWaveId===r.waveId&&l.previewSourceEmitterId===s.id?this.game.setSelectedWave(null,null):this.game.setSelectedWave(r.waveId,s.id))}}t&&(t.state="focused"),this.redrawAll(),this.updateLogHighlight();return}const n=this.emitters.findIndex(s=>s.id===this.focusedEmitterId);if(n===-1)return;let i=-1;switch(e.key){case"ArrowRight":i=(n+1)%this.emitters.length;break;case"ArrowLeft":i=(n-1+this.emitters.length)%this.emitters.length;break;case"ArrowUp":i=(n-1+this.emitters.length)%this.emitters.length;break;case"ArrowDown":i=(n+1)%this.emitters.length;break}if(i!==-1){this.focusedEmitterId=this.emitters[i].id;const s=this.emitters[i];s&&(s.state="focused"),this.redrawAll()}}getPointerCoordinates(e){return e instanceof MouseEvent?{clientX:e.clientX,clientY:e.clientY}:e.changedTouches&&e.changedTouches.length>0?{clientX:e.changedTouches[0].clientX,clientY:e.changedTouches[0].clientY}:null}handlePointerDown(e){if(e instanceof MouseEvent&&e.button!==0)return;const t=this.getPointerCoordinates(e);if(!t)return;const{clientX:n,clientY:i}=t,s=e.target,r=s.closest(".toolbar-gem:not(.placed)"),o=s.closest("#gem-canvas");e instanceof TouchEvent&&(o||r)&&e.preventDefault();let a=null,h=0,c=0;if(r){const u=r.getBoundingClientRect();h=n-u.left,c=i-u.top;const f=r.dataset.gemName;a={name:f,from:"toolbar",gridPattern:B[f].gridPattern,element:r,offsetX:h,offsetY:c}}else if(o){const u=this.gemCanvas.getBoundingClientRect(),f=n-u.left,m=i-u.top,E=this.getGemAtCanvasPos(f,m);if(E){const p=this._canvasToGridCoords(f,m);a={id:E.id,name:E.name,from:"board",gridPattern:E.gridPattern,offsetX:(p.x-E.x)*this.cellWidth,offsetY:(p.y-E.y)*this.cellHeight}}}a&&(this.dragStartInfo={item:a,startX:n,startY:i})}handlePointerMove(e){const t=this.getPointerCoordinates(e);if(!t)return;const{clientX:n,clientY:i}=t;if(this.dragStartInfo){if(e instanceof TouchEvent&&e.preventDefault(),!this.isDragging){const s=n-this.dragStartInfo.startX,r=i-this.dragStartInfo.startY;Math.sqrt(s*s+r*r)>5&&(this.isDragging=!0,this.draggedItemInfo=this.dragStartInfo.item,this.draggedItemInfo.element&&this.draggedItemInfo.element.classList.add("dragging"))}if(this.isDragging){const s=this.gemCanvas.getBoundingClientRect();this.dragPos={x:n-s.left,y:i-s.top},this.redrawAll()}}else e.target===this.gemCanvas?this.handleCanvasHover(n,i):this.handleCanvasMouseLeave()}handlePointerUp(e){var r;const t=this.getPointerCoordinates(e);if(!t)return;const{clientX:n,clientY:i}=t;if(this.isDragging&&this.draggedItemInfo){const o=this.gemCanvas.getBoundingClientRect();if(n>=o.left&&n<=o.right&&i>=o.top&&i<=o.bottom){const{x:h,y:c}=this.lastValidDropTarget,{gridPattern:u}=this.draggedItemInfo,f=u[0].length,m=u.length;h>=0&&c>=0&&h+f<=L&&c+m<=y&&(this.draggedItemInfo.from==="toolbar"?this.game.addPlayerGem(this.draggedItemInfo.name,h,c):this.draggedItemInfo.id&&this.game.movePlayerGem(this.draggedItemInfo.id,h,c))}else this.draggedItemInfo.from==="board"&&this.draggedItemInfo.id&&this.game.removePlayerGem(this.draggedItemInfo.id)}else if(e.target.closest("#gem-canvas")){const a=this.gemCanvas.getBoundingClientRect(),h=n-a.left,c=i-a.top,u=this.emitters.find(f=>f.isInside(h,c));if(u)if(!u.isUsed)this.game.sendWave(u.id);else{const f=l.log.find(m=>m.waveId===u.id||m.result.exitId===u.id);f?l.selectedLogEntryWaveId===f.waveId&&l.previewSourceEmitterId===u.id?this.game.setSelectedWave(null,null):this.game.setSelectedWave(f.waveId,u.id):this.game.setSelectedWave(null,null)}else{const f=this.getGemAtCanvasPos(h,c);f?(this.game.setSelectedWave(null,null),this.game.rotatePlayerGem(f.id)):this.game.setSelectedWave(null,null)}}(r=this.dragStartInfo)!=null&&r.item.element&&this.dragStartInfo.item.element.classList.remove("dragging"),this.dragStartInfo=null,this.isDragging=!1,this.draggedItemInfo=null,this.redrawAll(),this.updateToolbar()}getGemAtCanvasPos(e,t){if(e<0||t<0)return null;const{x:n,y:i}=this._canvasToGridCoords(e,t);for(let s=l.playerGems.length-1;s>=0;s--){const r=l.playerGems[s],o=r.gridPattern.length,a=r.gridPattern[0].length;if(n>=r.x&&n<r.x+a&&i>=r.y&&i<r.y+o&&r.gridPattern[i-r.y][n-r.x]!==d.EMPTY)return r}return null}_getPathColorName(e){if(e.absorbed)return"Absorbiert";if(e.colors.length===0)return"Keine Farbe";const t=[...e.colors].sort().join(",");return N[t]||"Unbekannte Mischung"}_createColorMixEntry(e){const t=x[e],n=e.split(","),i=document.createElement("div");i.className="color-mix-entry";let s="";n.forEach((o,a)=>{const h=v[o];s+=`<div class="color-mix-box" style="background-color: ${h}"></div>`,a<n.length-1&&(s+="<span>+</span>")});const r=N[e]||"Mischung";return s+=`<span>=</span> <div class="color-mix-box" style="background-color: ${t}"></div> <span>${r}</span>`,i.innerHTML=s,i}_populateColorMixColumns(e){if(!e)return;const t=document.createElement("div");t.className="color-mix-column";const n=document.createElement("div");n.className="color-mix-column";const i=["BLAU,ROT","BLAU,GELB","GELB,ROT","BLAU,ROT,WEISS","BLAU,GELB,WEISS","BLAU,GELB,ROT,WEISS"],s=["BLAU,WEISS","ROT,WEISS","GELB,WEISS","BLAU,GELB,ROT","GELB,ROT,WEISS"];i.forEach(r=>t.appendChild(this._createColorMixEntry(r))),s.forEach(r=>n.appendChild(this._createColorMixEntry(r))),e.appendChild(t),e.appendChild(n)}_populateIntroRules(){this.introRulesEl.innerHTML=`
            <h3>Spielanleitung</h3>
            <p><strong>Ziel:</strong> Finde die Position und Ausrichtung der versteckten Edelsteine.</p>
            <ul>
                <li>Sende Lichtwellen von den Rändern in das Spielfeld.</li>
                <li>Die austretende Farbe und Position verraten, welche Steine getroffen wurden.</li>
                <li>Ziehe Edelsteine aus der Werkzeugleiste auf das Feld. Du kannst sie verschieben und drehen.</li>
                <li>Ein Klick auf einen platzierten Stein dreht ihn um 90°.</li>
                <li>Steine dürfen sich nicht überlappen oder Kante an Kante liegen.</li>
                <li>Drücke <strong>'n'</strong> für ein neues Level oder <strong>'esc'</strong> um zum Menü zurückzukehren.</li>
            </ul>
            <h4>Farbmischung</h4>
            <p>Wenn ein Lichtstrahl mehrere farbige Steine durchquert, mischen sich ihre Farben:</p>
            <div class="color-mix-container"></div>
        `;const e=this.introRulesEl.querySelector(".color-mix-container");this._populateColorMixColumns(e)}_populateRulesPanel(){this.rulesPanel.innerHTML=`
            <h4>Grundregeln</h4>
            <ul>
                <li><strong>Ziel:</strong> Finde die Position und Ausrichtung der versteckten Edelsteine.</li>
                <li>Sende Lichtwellen, um zu sehen, wo sie austreten und welche Farbe sie haben.</li>
                <li>Ziehe die Edelsteine auf das Feld, um die Lösung nachzubauen.</li>
                <li>Klicke auf einen platzierten Stein, um ihn zu <strong>drehen</strong>.</li>
                <li>Steine dürfen sich nicht überlappen oder Kante an Kante liegen.</li>
            </ul>
            <h4>Farbmischung</h4>
            <p>Wenn ein Lichtstrahl mehrere farbige Steine durchquert, mischen sich ihre Farben:</p>
            <div class="color-mix-container"></div>
        `;const e=this.rulesPanel.querySelector(".color-mix-container");this._populateColorMixColumns(e)}_drawSelectedWaveTooltip(e){if(!l.selectedLogEntryWaveId)return;const t=l.log.find(C=>C.waveId===l.selectedLogEntryWaveId);if(!t)return;const n=l.previewSourceEmitterId||t.waveId,i=this.emitters.find(C=>C.id===n);if(!i)return;const s=t.waveId,r=t.result.exitId,o=this._getPathColorName(t.result),a=n===s?`${s} ➔ ${o} ➔ ${r}`:`${r} ➔ ${o} ➔ ${s}`;e.save();const h=this.cellHeight*.35;e.font=`bold ${h}px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif`,e.textBaseline="middle";const c=e.measureText(a),u={x:8,y:5},f=c.width+u.x*2,m=h+u.y*2,E=6,p=i.rect,T=5,R=this.gemCanvas.width/(window.devicePixelRatio||1),w=this.gemCanvas.height/(window.devicePixelRatio||1);let I=0,S=0;S=p.y+p.height+T,I=p.x+p.width/2-f/2,S+m>w&&(S=p.y-m-T,S<0&&(I=p.x+p.width+T,S=p.y+p.height/2-m/2,I+f>R&&(I=p.x-f-T))),I<0&&(I=0),I+f>R&&(I=R-f),S<0&&(S=0),S+m>w&&(S=w-m);const G=I+f/2,M=S+m/2;e.fillStyle="black",e.beginPath(),e.roundRect(I,S,f,m,E),e.fill(),e.fillStyle="white",e.textAlign="center",e.fillText(a,G,M),e.restore()}}document.addEventListener("DOMContentLoaded",()=>{const g=new ee,e=new Q(g);window.game=e});
